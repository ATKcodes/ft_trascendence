<html lang="en">
<head>
	<!-- Bootstrap CSS -->
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
	<link rel="stylesheet" href="styles.css">
	<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
	<title>PONG</title>
	<style>
	.select-language{
		background-color: #B6A999;
		color: #000000;
		position: absolute;
		right: 8%;
		top: 5%;
		width: 4%;
		padding : 0.5%;
		margin: 0 auto;
		text-align: left;
	}
	.div-friends{
		position: absolute;
		right: 3%;
		bottom: 5%;
		width: 20%;
		padding : 0.5%;
		margin: 0 auto;
		text-align: center;
	
	}
	.div-title {
		font-family: 'font-Despairs';
		font-size: 250%;
		position: absolute;
		left: 45%; /* Change this to move the div horizontally */
		right: 2%;
		top: 0%; /* Change this to move the div vertically */
		width: 15%;
		padding : 1%;
		color: black;
		}
	.div-friendsmenu {
		position: absolute;
		right: 5%;
		bottom: 3%;
		width: 15%;
		height: 40%;
		padding : 1%;
		margin: 0 auto;
		text-align: center;
		background-color: #B6A999;
	}
	.avatar {
		width: 50px;
		height: 50px;
		border-radius: 50%;
		font-weight: lighter;
		font-size :110%;
		color: #ffffff;
		position: absolute;
		left: 2%;
		top: 1.5%;
		padding : 0.5%;
		margin: 0 auto;
		text-align: center;
	}
	.avatar2 {
		width: 50px;
		height: 50px;
		border-radius: 50%;
		font-weight: lighter;
		font-size :110%;
		color: #ffffff;
		position: absolute;
		right: 2%;
		top: 1.5%;
		padding : 0.5%;
		margin: 0 auto;
		text-align: center;
	}
	.btn-left {
		font-weight: lighter;
		font-size :110%;
		background-color: #000000;
		color: #ffffff;
		position: absolute;
		left: 20%;
		top: 45%;
		width: 20%;
		padding : 0.5%;
		margin: 0 auto;
		text-align: center;
		border-color: #ffffff;
	}
	.btn-left-top {
		font-weight: lighter;
		font-size :110%;
		background-color: #000000;
		color: #ffffff;
		position: absolute;
		left: 20%;
		top: 40%;
		width: 20%;
		padding : 0.5%;
		margin: 0 auto;
		text-align: center;
		border-color: #ffffff;
	}
	.btn-left-bottom {
		font-weight: lighter;
		font-size :110%;
		background-color: #000000;
		color: #ffffff;
		position: absolute;
		left: 20%;
		top: 50%;
		width: 20%;
		padding : 0.5%;
		margin: 0 auto;
		text-align: center;
		border-color: #ffffff;
	}
	.btn-right-top{
		font-weight: lighter;
		font-size :110%;
		background-color: #000000;
		color: #ffffff;
		position: absolute;
		right: 20%;
		top: 40%;
		width: 20%;
		padding : 0.5%;
		margin: 0 auto;
		text-align: center;
		border-color: #ffffff;
	}
	.btn-right-bottom{
		font-weight: lighter;
		font-size :110%;
		background-color: #000000;
		color: #ffffff;
		position: absolute;
		right: 20%;
		top: 50%;
		width: 20%;
		padding : 0.5%;
		margin: 0 auto;
		text-align: center;
		border-color: #ffffff;
	}
	.btn-right {
		font-weight: lighter;
		font-size :110%;
		background-color: #000000;
		color: #ffffff;
		position: absolute;
		right: 20%;
		top: 45%;
		width: 20%;
		padding : 0.5%;
		margin: 0 auto;
		text-align: center;
		border-color: #ffffff;
	}
	.btn-nohover:hover {
		visibility: visible !important;
        opacity: 1 !important;
	}
	.open_text {
		font-size: 200%;
		text-align: center;
		position: absolute;
		width: 60%;
		height: 75%;
		left: 20%;
		right: 2%;
		top: 20%;
		bottom: 10%;
		background-color: #000000;
		color: #ffffff;
	}
	.select {
		background-image: url('download.jpeg');
		border-radius: 50%;
		color: #000000;
		position: absolute;
		left: 3%;
		top: 5%;
		padding : 0.5%;
		margin: 0 auto;
		text-align: left;
	}
	.dropdown {
		position: relative;
		display:flex;
		top: 5%;
	}
	.dropdown-menu {
		display: none;
		position: absolute;
		background-color: #f9f9f9;
		min-width: 160px;
		box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
		z-index: 1;
	}
	.dialog {
		display: none;
		background-color: #f9f9f9;
	}
	.userleft{
		position: absolute;
		left: 5%;
		top: 2.5%;
		padding : 0.5%;
		margin: 0 auto;
		text-align: center;
	}	
	.userright{
		position: absolute;
		right: 5%;
		top: 2.5%;
		padding : 0.5%;
		margin: 0 auto;
		text-align: center;
	}
	#pong-game {
    	position: relative;
		width: 96%;
		height: 90%;
		left: 2%;
		right: 2%;
		top: 8%;
		bottom: 10%;
		background-color: #000000;
		color: #ffffff;
	    border: 1px solid black;
	}

	#ball {
		position: absolute;
		height: 10px;
		width: 10px;
		background: black;
		color : white;
	}

	#paddleA, #paddleB {
		position: absolute;
		height: 80px;
		width: 10px;
		background: black;
		color : white;
	}

	#paddleA {
		left: 0;
	}

	#paddleB {
		right: 0;
	}

	#ball, #paddleA, #paddleB {
		background: white;
   		z-index: 2;
}
	</style>
</head>
<body>
    <img src="download.jpeg" alt="Avatar" class="avatar" id="go_to_profle">
    <h5 class = "userleft">User1</h5>
    <h2 id="go_to_main" class="div-title" style="user-select:none;">PONG</h2>
    <script>
        document.getElementById("go_to_main").addEventListener("click", function() {
            localStorage.setItem('lastPage', "main-page");
            window.parent.goToMain();
        });
    </script>
    <img src="download.jpeg" alt="Avatar" class="avatar2" id="go_to_profle">
    <h5 id = "userright"class = "userright">User2</h5>
    <div id="pong-game">
        <div id="scoreBoard" style="display: flex; justify-content: center; align-items: center; position: absolute; width: 100%; top: 1%; padding: 10px; ">
            <div><span id="scoreA" style="font-size: 24px; color: white;">0</span></div>
            <div style="margin-left: 20px;"><span id="scoreB" style="font-size: 24px; color: white;">0</span></div>
        </div>
        <div id="ball"></div>
        <div id="paddleA"></div>
        <div id="paddleB"></div>
    </div>
    <input id="player2-username" type="text" style="display: none;" class="btn btn-left btn-block btn-lg" placeholder="Insert Player2 Nick">
    <button id="submit-username" type="button" class="btn btn-right btn-lg btn-block" style="display: none;">Submit</button>
	<input id="player2-username-tris" type="text" style="display: none;" class="btn btn-left btn-block btn-lg" placeholder="Insert Player2 Nick">
    <button id="submit-username-tris" type="button" class="btn btn-right btn-lg btn-block" style="display: none;">Submit</button>
    <button id="play-pong" type="button" class="btn btn-nohover btn-left btn-lg btn-block">Play Pong</button>
    <button id="play-tris" type="button" class="btn-nohover btn btn-right btn-lg btn-block">Play Tris</button>
	<button id="play-tris-1v1" style="display: none;"type="button" class="btn-nohover btn btn-left btn-lg btn-block">Play 1v1</button>
	<button id="play-tris-tournament" style="display: none;" type="button" class="btn-nohover btn btn-right btn-lg btn-block">Play Tournament</button>
    <button id="play-1v1" type="button" class="btn btn-left-top btn-lg btn-block" style="display: none;">Play 1v1</button>
    <button id="play-4players" type="button" class="btn btn-left-bottom btn-lg btn-block" style="display: none;">Play in 4 Players</button>
    <button id="play-vs-ia" type="button" class="btn btn-right-top btn-lg btn-block" style="display: none;">Play vs IA</button>
    <button id="play-tournament" type="button" class="btn btn-right-bottom btn-lg btn-block" style="display: none;">Play Tournament</button>
	<div class="open_text" style="display: none;">The game is over. The winner is: <span id="winner"></span></div>
	<button id = "NextMatch" style = "display: none;" class = "btn btn-left btn-lg btn-block"></button>
</body>
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script>
	var pongGame;
	window.onload = function(){
	pongGame = {
		gameMode: "1v1",
		game: document.getElementById('pong-game'),
		ball: document.getElementById('ball'),
		paddleA: document.getElementById('paddleA'),
		paddleB: document.getElementById('paddleB'),
		ballPos: {x: 0, y: 0},
		paddleAPos: {y: 0},
		paddleBPos: {y: 0},
	    ballSpeed: {x: 8, y: 8},
		paddleASpeed: 0,
    	paddleBSpeed: 0,
    	paddleSpeed: 6,
		scoreA: 0,
   		scoreB: 0,
		bouncecounter: 0,
		balllimitfaster: 2,
		ballaccelleration: 1,
		matchdatasent : 0,

		update: function() {
        // Update the position of the ball
        this.ballPos.x += this.ballSpeed.x;
        this.ballPos.y += this.ballSpeed.y;

		// Update the position of the paddles
		this.paddleAPos.y += this.paddleASpeed;
		
		if (pongGame.gameMode === 'vs-ai') {
        // Move the right paddle based on the ball's position
        if (pongGame.ballPos.y > pongGame.paddleBPos.y) {
            pongGame.paddleBSpeed = pongGame.paddleSpeed;
        } else if (pongGame.ballPos.y < pongGame.paddleBPos.y) {
            pongGame.paddleBSpeed = -pongGame.paddleSpeed;
        } else {
            pongGame.paddleBSpeed = 0;
        }
    } else {
        this.paddleBPos.y += this.paddleBSpeed;
    }
		this.paddleBPos.y += this.paddleBSpeed;
        // Prevent the paddles from going out of the game area
        this.paddleAPos.y = Math.max(Math.min(this.paddleAPos.y, this.game.offsetHeight - this.paddleA.offsetHeight), 0);
        this.paddleBPos.y = Math.max(Math.min(this.paddleBPos.y, this.game.offsetHeight - this.paddleB.offsetHeight), 0);

        // Check for goals
        if (this.ballPos.x < 0) { // Ball touches the left border
            this.scoreB++; // Increment score for Player B
            this.resetBall(); // Reset the ball to the center
        } else if (this.ballPos.x + this.ball.offsetWidth > this.game.offsetWidth) { // Ball touches the right border
            this.scoreA++; // Increment score for Player A
            this.resetBall(); // Reset the ball to the center
        }

		// Check for collisions for top and bottom boundaries
        if (this.ballPos.y < 0 || this.ballPos.y + this.ball.offsetHeight > this.game.offsetHeight) {
            this.ballSpeed.y *= -1; // Reverse the vertical direction
        }

        // Update scores display, if you have elements to show scores
        document.getElementById("scoreA").textContent = this.scoreA;
        document.getElementById("scoreB").textContent = this.scoreB;

        // Collision detection with the paddles
        if ((this.ballPos.x < this.paddleA.offsetWidth && this.ballPos.y + this.ball.offsetHeight > this.paddleAPos.y && this.ballPos.y < this.paddleAPos.y + this.paddleA.offsetHeight) ||
            (this.ballPos.x + this.ball.offsetWidth > this.game.offsetWidth - this.paddleB.offsetWidth && this.ballPos.y + this.ball.offsetHeight > this.paddleBPos.y && this.ballPos.y < this.paddleBPos.y + this.paddleB.offsetHeight)) {
            this.ballSpeed.x *= -1; // Reverse the horizontal direction
			this.bouncecounter++;
        }
		if (this.bouncecounter == this.balllimitfaster){
			this.balllimitfaster = this.balllimitfaster * 2;
			this.ballSpeed.x = this.ballSpeed.x + 1;
			this.ballSpeed.y = this.ballSpeed.y + 1;
		}
		// Check if player A has reached 5 points
		if (this.scoreA >= 5) {
			this.endGame(document.querySelector('.userleft').textContent);
       		return;
		// Check if player B has reached 5 points
		if (this.scoreB >= 5) {
        this.endGame(document.querySelector('.userright').textContent);
        return;
    }
    }

    },
	endGame: function(winner) {
    // Reset the ball
    this.resetBall();
	this.ballSpeed.x = 0;
	this.ballSpeed.y = 0;
	this.ball.style.display = "none";
	this.paddleA.style.display = "none";
	this.paddleB.style.display = "none";
	win = true;

	if (winner = document.querySelector('.userleft').textContent)
	{
		win = true;
	}
	else 
	{
		win = false;
	}

    // Save match data
    var matchData = {
		token:localStorage.getItem('token'),
		game: "pong",
		win: win,
		score: this.scoreA,
        scoreplayer2: this.scoreB,
   		player2: document.querySelector('.userright').textContent, // Get User2 name
        date: new Date().toISOString(),
    };
    var jsonMatchData = JSON.stringify(matchData);
	if (matchdatasent === 0)
	{
		sendMatchData(jsonMatchData);
	}
},

	resetBall: function() {
		console.log(this.bouncecounter);
		console.log(this.ballSpeed.x);
        // Reset ball position to the center of the game area
        this.ballPos.x = this.game.offsetWidth / 2 - this.ball.offsetWidth / 2;
        this.ballPos.y = this.game.offsetHeight / 2 - this.ball.offsetHeight / 2;
        // Optionally, reset ball speed or direction
		this.ballSpeed.x = 8;
		this.ballSpeed.y = 8;
		this.bouncecounter = 0;
		this.balllimitfaster = 2;
	},

	draw: function() {
    // Update the position of the ball
    this.ball.style.top = this.ballPos.y + 'px';
    this.ball.style.left = this.ballPos.x + 'px';

    // Update the position of paddle A
    this.paddleA.style.top = this.paddleAPos.y + 'px';

    // Update the position of paddle B
    this.paddleB.style.top = this.paddleBPos.y + 'px';
},

    loop: function() {
        pongGame.update();
        pongGame.draw();
        requestAnimationFrame(pongGame.loop);
    },

    start: function() {
        pongGame.loop();
    }
};
function sendMatchData(jsonMatchData){
	fetch('http://localhost:8001/main/winlose/', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json'
			},
			body: jsonMatchData
		}).then(response => {
			if (response.ok) {
				console.log('Match data sent successfully');
			} else {
				console.error('Error sending match data:', response.statusText);
			}
		}).catch(error => {
			console.error('Network error:', error);
		});
	matchdatasent = 0;
}

document.addEventListener('keydown', function(event) {
    switch (event.key) {
        case 'w':
            pongGame.paddleASpeed = -pongGame.paddleSpeed;
            break;
        case 's':
            pongGame.paddleASpeed = pongGame.paddleSpeed;
            break;
        case 'ArrowUp':
            pongGame.paddleBSpeed = -pongGame.paddleSpeed;
            break;
        case 'ArrowDown':
            pongGame.paddleBSpeed = pongGame.paddleSpeed;
            break;
    }
});

document.addEventListener('keyup', function(event) {
    switch (event.key) {
        case 'w':
        case 's':
            pongGame.paddleASpeed = 0;
            break;
        case 'ArrowUp':
        case 'ArrowDown':
            pongGame.paddleBSpeed = 0;
            break;
    }
});

	pongGame.ballPos = {x: pongGame.game.offsetWidth/2, y: pongGame.game.offsetHeight/2},
    pongGame.paddleAPos = {y: pongGame.game.offsetHeight/2 - pongGame.paddleA.offsetHeight/2},
    pongGame.paddleBPos = {y: pongGame.game.offsetHeight/2 - pongGame.paddleB.offsetHeight/2},


document.getElementById("play-pong").addEventListener("click", function() {
    document.getElementById("play-pong").style.display = "none";
    document.getElementById("play-tris").style.display = "none";
	
	// Show the new buttons
	document.getElementById("play-1v1").style.display = "block";
    document.getElementById("play-4players").style.display = "block";
    document.getElementById("play-vs-ia").style.display = "block";
    document.getElementById("play-tournament").style.display = "block";
    
});
document.getElementById("play-1v1").addEventListener("click", function(){
	document.getElementById("play-1v1").style.display = "none";
    document.getElementById("play-4players").style.display = "none";
    document.getElementById("play-vs-ia").style.display = "none";
    document.getElementById("play-tournament").style.display = "none";
	document.getElementById("player2-username").style.display = "block";
    document.getElementById("submit-username").style.display = "block";
});
//Funzione per cambiare il nick dell'user2.
document.getElementById("submit-username").addEventListener("click", function() {
    var username = document.getElementById("player2-username").value;

    if (username) {
        // Save the username for player 2
		document.getElementById("userright").textContent = username;
		document.getElementById("player2-username").style.display = "none";
		document.getElementById("submit-username").style.display = "none";
        // Start the game
        pongGame.start();
    } else {
        alert("Please enter a username for player 2.");
    }
});
document.getElementById("play-vs-ia").addEventListener("click", function(){
	document.getElementById("userright").textContent = "IA";
	document.getElementById("play-1v1").style.display = "none";
    document.getElementById("play-4players").style.display = "none";
    document.getElementById("play-vs-ia").style.display = "none";
    document.getElementById("play-tournament").style.display = "none";
	pongGame.gameMode = "vs-ai";
	pongGame.start();
});

//TRIS CODE
document.getElementById("play-tris").addEventListener("click", function(){
	document.getElementById("play-pong").style.display = "none";
	document.getElementById("play-tris").style.display = "none";
	document.getElementById("play-tris-1v1").style.display = "block";
	document.getElementById("play-tris-tournament").style.display = "block";
});
document.getElementById("play-tris-1v1").addEventListener("click", function(){
	document.getElementById("play-tris-1v1").style.display = "none";
    document.getElementById("play-tris-tournament").style.display = "none";
	document.getElementById("player2-username-tris").style.display = "block";
    document.getElementById("submit-username-tris").style.display = "block";
});
//Funzione per cambiare il nick dell'user2 nel gioco tris
document.getElementById("submit-username-tris").addEventListener("click", function() {
    var username = document.getElementById("player2-username-tris").value;

    if (username) {
        // Save the username for player 2
		document.getElementById("userright").textContent = username;
		document.getElementById("player2-username-tris").style.display = "none";
		document.getElementById("submit-username-tris").style.display = "none";
        // Start the game
		// QUI INSERISCI LA FUNZIONE CHE FA PARTIRE TRIS
    } else {
        alert("Please enter a username for player 2.");
    }
});
}
</script>
</html>