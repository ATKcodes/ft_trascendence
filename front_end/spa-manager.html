<!DOCTYPE html>
<html>
	<head>
		<title>PONG</title>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0"> 
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
		<link rel="stylesheet" href="styles.css">
	</head>
	<body style="height: 100vh;"> <!-- Set the body height to 100vh -->
        <iframe id="login" src="login.html" style="height: 100%; width: 100%; border: none;"></iframe>
        <iframe id="main-page" src="main-page.html" style="height: 100%; width: 100%; border: none; display: none;"></iframe>
        <iframe id ="profile" src="profile.html" style="height: 100%; width: 100%; border: none; display: none;"></iframe>
		<iframe id ="game-page" src="game-page.html" style="height: 100%; width: 100%; border: none; display: none;"></iframe>
		<iframe id ="404" src="404.html" style="height: 100%; width: 100%; border: none; display: none;"></iframe>
		<script>
		var validPaths = ['profile', 'game-page', 'login', 'main-page'];
		function goToMain() {
			document.getElementById("login").style.display = "none";
			document.getElementById("main-page").style.display = "block";
			document.getElementById("profile").style.display = "none";
			document.getElementById("game-page").style.display = "none";
			document.getElementById("404").style.display = "none";

			// Change the URL to 'main-page.html'
			history.pushState({page: 'main-page'}, null, 'main-page');
		}

			// Handle the back and forward navigation
			window.onpopstate = function(event) {
		// Get the current path
		var currentPath = window.location.pathname;

		// Hide all iframes
		document.getElementById("login").style.display = "none";
		document.getElementById("main-page").style.display = "none";
		document.getElementById("profile").style.display = "none";
		document.getElementById("game-page").style.display = "none";
		document.getElementById("404").style.display = "none";

		// Check if the current path is in the list of valid paths
		if (validPaths.includes(currentPath)) {
			// If it is, show the iframe of the current page
			if (event.state) {
				document.getElementById(event.state.page).style.display = "block";
			}
		} else {
			// If it's not, show the 404 page
			goTo404();
		}
	};

	function goTo404() {
		// Hide all pages
		document.getElementById("game-page").style.display = "none";
		document.getElementById("main-page").style.display = "none";
		document.getElementById("profile").style.display = "none";
		document.getElementById("login").style.display = "none";
		document.getElementById("404").style.display = "none";

		// Show the 404 page
		document.getElementById("404").style.display = "block";

		// Change the URL to '404.html'
		history.pushState({page: '404'}, null, '404');

		};
		function goToProfile() {
			document.getElementById("game-page").style.display = "none";
			document.getElementById("main-page").style.display = "none";
			document.getElementById("profile").style.display = "block";
			document.getElementById("login").style.display = "none";
			document.getElementById("404").style.display = "none";
	
			// Change the URL to 'profile.html'
			history.pushState({page: 'profile'}, null, 'profile');
  		}
		function goToGame() {
			document.getElementById("main-page").style.display = "none";
			document.getElementById("game-page").style.display = "block";
			document.getElementById("profile").style.display = "none";
			document.getElementById("login").style.display = "none";
			document.getElementById("404").style.display = "none";

	        // Change the URL to 'game-page.html'
			history.pushState({page: 'game-page'}, null, 'game-page');
		}
		function goToLogin() {
			document.getElementById("main-page").style.display = "none";
			document.getElementById("login").style.display = "block";
			document.getElementById("profile").style.display = "none";
			document.getElementById("game-page").style.display = "none";
			document.getElementById("404").style.display = "none";

	        // Change the URL to 'game-page.html'
			history.pushState({page: 'login'}, null, 'login');
		}

		window.onload = function() {
			// Attempt to get the lastPage from localStorage
			var lastPage = localStorage.getItem('lastPage');

			// Hide all pages
			document.getElementById("game-page").style.display = "none";
			document.getElementById("main-page").style.display = "none";
			document.getElementById("profile").style.display = "none";
			document.getElementById("login").style.display = "none";
			document.getElementById("404").style.display = "none";

			// Function to show the page based on id
			function showPage(pageId) {
				var pageElement = document.getElementById(pageId);
				if (pageElement) {
					pageElement.style.display = "block";
					history.replaceState({page: pageId}, null, pageId);
				}
			}

			// If lastPage exists in localStorage, show it
			if (lastPage && document.getElementById(lastPage)) {
				showPage(lastPage);
			} else {
				// Default behavior based on URL
				var url = window.location.href;
				if (url.includes('spa-manager')) {
					showPage("login"); // Default to login if 'spa-manager' is in the URL but no lastPage is saved
				} else if (url.includes('profile')) {
					showPage("profile");
				} else if (url.includes('game-page')) {
					showPage("game-page");
				} else if (url.includes('login')) {
					showPage("login");
				} else if (url.includes('main-page')) {
					showPage("main-page");
				} else if (url.includes('404')){
					showPage("404")
				}
			}
		};

    	// Handle the back and forward navigation
    	window.onpopstate = function(event) {
        	if (event.state) {
            	// If the user navigates back to the 'spa-manager' page, change the URL to 'login.html'
            	if (event.state.page === 'spa-manager') {
                	history.replaceState({page: 'spa-manager'}, null, 'login');
            	}
				// Hide all pages
				document.getElementById("game-page").style.display = "none";
				document.getElementById("main-page").style.display = "none";
				document.getElementById("profile").style.display = "none";
				document.getElementById("login").style.display = "none";
				document.getElementById("404").style.display = "none";

				// Show the page based on the state object
				if (event.state.page === 'spa-manager') {
					history.replaceState({page: 'spa-manager'}, null, 'login');
					document.getElementById("login").style.display = "block";
				} else if (event.state.page === 'profile') {
					document.getElementById("profile").style.display = "block";
				} else if (event.state.page === 'game-page') {
					document.getElementById("game-page").style.display = "block";
				} else if (event.state.page === 'login') {
					document.getElementById("login").style.display = "block";
				} else if (event.state.page === 'main-page') {
					document.getElementById("main-page").style.display = "block";
				} else if (event.state.page === '404') {
            		// If the state is '404', go back to the previous page
            		history.back();
       	 		}
			}
    	};

	document.addEventListener('DOMContentLoaded', function() {
    const userToken = localStorage.getItem('userToken');
    const lastPage = localStorage.getItem('lastPage') || 'login';

    if (userToken && lastPage !== 'login') {
        console.log('User token found:', userToken);
        // Assuming setPageBasedOnState does the actual page showing
        setPageBasedOnState({page: lastPage});
    } else {
        console.log('No user token found, please log in');
        setPageBasedOnState({page: 'login'});
    }
});

function setPageBasedOnState(state) {
    const pageIds = ["login", "profile", "main-page", "game-page", "404"];
    pageIds.forEach(id => {
        const pageElement = document.getElementById(id);
        if (pageElement) {
            pageElement.style.display = "none";
        }
    });
    if (state.page && document.getElementById(state.page)) {
        console.log("Showing page:", state.page);
        document.getElementById(state.page).style.display = "block";
        localStorage.setItem('lastPage', state.page); // Correctly update localStorage
    } else {
        console.log("No page specified, showing login");
        document.getElementById("login").style.display = "block";
    }
}
	</script>
  </body>
</html>