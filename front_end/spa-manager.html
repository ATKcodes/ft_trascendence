<!DOCTYPE html>
<html>
	<head>
		<title>PONG</title>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0"> 
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
		<link rel="stylesheet" href="styles.css">
		<script src="User.js" type="module"></script>
	</head>
	<body style="height: 100vh;"> <!-- Set the body height to 100vh -->
        <iframe id="login" src="login.html" style="height: 100%; width: 100%; border: none;"></iframe>
        <iframe id="main-page" src="main-page.html" style="height: 100%; width: 100%; border: none; display: none;"></iframe>
        <iframe id ="profile" src="profile.html" style="height: 100%; width: 100%; border: none; display: none;"></iframe>
		<iframe id ="game-page" src="game-page.html" style="height: 100%; width: 100%; border: none; display: none;"></iframe>
		<iframe id ="404" src="404.html" style="height: 100%; width: 100%; border: none; display: none;"></iframe>
		<iframe id = "tris-game" src="tris-game.html" style="height: 100%; width: 100%; border: none; display: none;"></iframe>
		<script>

		function goToMain() {
			hidePages();
			document.getElementById("main-page").style.display = "block";
			// Change the URL to 'main-page.html'
			history.pushState({page: 'main-page'}, null, 'main-page');
		}
		var validPaths = ['profile', 'game-page', 'login', 'main-page', 'tris-game'];
		// Handle the back and forward navigation
		window.onpopstate = function(event) {
		// Get the current path
		var currentPath = window.location.pathname.slice(1);

		// Hide all iframes
		hidePages();

		// Check if the current path is in the list of valid paths
		if (validPaths.includes(currentPath)) {
			// If it is, show the iframe of the current page
			if (event.state) {
				document.getElementById(event.state.page).style.display = "block";
			}
		} else {
			// If it's not, show the 404 page
			goTo404();
		}
	};

	function goTo404() {
			hidePages();
			var errorPage = document.getElementById("404");
			errorPage.style.display = "block";
			errorPage.src = errorPage.src; // This will refresh the iframe
			history.replaceState({page: '404'}, null, '404');
		};
		function goToProfile() {
			hidePages();
			var profilePage = document.getElementById("profile");
			profilePage.style.display = "block";
			profilePage.src = profilePage.src; // This will refresh the iframe
			history.pushState({page: 'profile'}, null, 'profile');
  		}
		  function goToGame() {
    		hidePages();
			var gamePage = document.getElementById("game-page");
			gamePage.style.display = "block";
			gamePage.src = gamePage.src; // This will refresh the iframe
			history.pushState({page: 'game-page'}, null, 'game-page');
		}
		function goToLogin() {
			hidePages();
			var LoginPage = document.getElementById("login");
			LoginPage.style.display = "block";
			LoginPage.src = LoginPage.src; // This will refresh the iframe
			history.pushState({page: 'login'}, null, 'login');
		}
		function goToTris() {
			hidePages();
			var TrisPage = document.getElementById("tris-game");
			TrisPage.style.display = "block";
			TrisPage.src = TrisPage.src; // This will refresh the iframe
			history.pushState({page: 'tris-game'}, null, 'tris-game');
		}
		

		window.onload = function() {
			// Attempt to get the lastPage from localStorage
			var lastPage = localStorage.getItem('lastPage');
			// Hide all pages
			hidePages();
			// Function to show the page based on id
			function showPage(pageId) {
				var pageElement = document.getElementById(pageId);
				if (pageElement) {
					pageElement.style.display = "block";
					history.replaceState({page: pageId}, null, pageId);
				}
			}

			// If lastPage exists in localStorage, show it
			if (lastPage && document.getElementById(lastPage)) {
				showPage(lastPage);
			} else {
				// Default behavior based on URL
				var url = window.location.href;
				if (url.includes('spa-manager')) {
					showPage("login"); // Default to login if 'spa-manager' is in the URL but no lastPage is saved
				} else if (url.includes('profile')) {
					showPage("profile");
				} else if (url.includes('game-page')) {
					showPage("game-page");
				} else if (url.includes('login')) {
					showPage("login");
				} else if (url.includes('main-page')) {
					showPage("main-page");
				} else if (url.includes('tris-game')) {
					showPage("tris-game");
				} else if (url.includes('404')){
					showPage("404")
				}
			}
		};

    	// Handle the back and forward navigation
    	window.onpopstate = function(event) {
        	if (event.state) {
            	// If the user navigates back to the 'spa-manager' page, change the URL to 'login.html'
            	if (event.state.page === 'spa-manager') {
                	history.replaceState({page: 'spa-manager'}, null, 'login');
            	}
				// Hide all pages
				hidePages();

				// Show the page based on the state object
				if (event.state.page === 'spa-manager') {
					history.replaceState({page: 'spa-manager'}, null, 'login');
					document.getElementById("login").style.display = "block";
				} else if (event.state.page === 'profile') {
					document.getElementById("profile").style.display = "block";
				} else if (event.state.page === 'game-page') {
					document.getElementById("game-page").style.display = "block";
				} else if (event.state.page === 'login') {
					document.getElementById("login").style.display = "block";
				} else if (event.state.page === 'main-page') {
					document.getElementById("main-page").style.display = "block";
				} else if (event.state.page === 'tris-game') {
					document.getElementById("tris-game").style.display = "block";
				} else if (event.state.page === '404') {
					document.getElementById("404").style.display = "block";
				}
			}
    	};

	document.addEventListener('DOMContentLoaded', function() {
    const userToken = localStorage.getItem('userToken');
    const lastPage = localStorage.getItem('lastPage') || 'login';

    if (userToken && lastPage !== 'login') {
        console.log('User token found:', userToken);
        // Assuming setPageBasedOnState does the actual page showing
        setPageBasedOnState({page: lastPage});
    } else {
        console.log('No user token found, please log in');
        setPageBasedOnState({page: 'login'});
    }
});

function setPageBasedOnState(state) {
    const pageIds = ["login", "profile", "main-page", "game-page", "tris-game", "404"];
    pageIds.forEach(id => {
        const pageElement = document.getElementById(id);
        if (pageElement) {
            pageElement.style.display = "none";
        }
    });
    if (state.page && document.getElementById(state.page)) {
        console.log("Showing page:", state.page);
        document.getElementById(state.page).style.display = "block";
        localStorage.setItem('lastPage', state.page); // Correctly update localStorage
    } else {
        console.log("No page specified, showing login");
        document.getElementById("login").style.display = "block";
    }
}

	// Handle page state on popstate event
	window.onpopstate = function(event) {
		setPageBasedOnState(event.state);
	};
	class User {
        constructor(name, token) {
            this.name = name;
            this.token = token;
        }
    }
	function hidePages(){
		document.getElementById("game-page").style.display = "none";
		document.getElementById("main-page").style.display = "none";
		document.getElementById("profile").style.display = "none";
		document.getElementById("login").style.display = "none";
		document.getElementById("404").style.display = "none";
		document.getElementById("tris-game").style.display = "none";
	}
	</script>
	<script>
		import("./User.js").then((module) => {
			const User = module.default;
			const userInstance = new User();
			console.log("User.js loaded", userInstance.nickname);
		}); 
	</script>
  </body>
</html>